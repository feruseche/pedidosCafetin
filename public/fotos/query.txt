SELECT pacientes.ultimo_abono, DATEDIFF( CURDATE( ) , pacientes.ultimo_abono ) AS dias,pacientes.id_agencia,sucursales.codigo,pacientes.historia,pacientes.paciente,pacientes.direccion,CONCAT(pacientes.telefonos,' ',pacientes.telefono_movil) AS telefonos,presupuestos.status, SUM(precio), SUM(pagado), SUM(precio-pagado), COUNT(presupuestos.historia) FROM sucursales,pacientes,presupuestos WHERE sucursales.id_agencia=pacientes.id_agencia AND pacientes.historia=presupuestos.historia AND presupuestos.status="F" AND presupuestos.saldo>0 GROUP BY pacientes.paciente,presupuestos.status ORDER BY pacientes.historia,presupuestos.status